# Control Strategy & Environment Model Rules

This document outlines the logic dictating how the **Planner** makes decisions based on sensor data, and how the **Environment** simulates the physical response of the poultry farm.

## 1. Planner Strategy (Control Logic)

The planner (`planner/planner_service.py`) uses a feedback control loop to maintain optimal conditions.

### 1.1. Fan Control
The fan speed is determined by a Proportional-only (P) controller based on Temperature and CO2 levels, with an override for Ammonia (NH3).

**Equation:**
```python
# Error Calculation
temp_error = max(0, temp - TEMP_SETPOINT)
co2_error = max(0, co2 - CO2_SETPOINT)

# P-Control Contribution
fan_level = (FAN_KP_TEMP * temp_error) + (FAN_KP_CO2 * co2_error)
```

**Overrides & Modifiers:**
*   **Ammonia Boost:** If `nh3 > NH3_THRESHOLD`, `fan_level += 30.0`.
*   **Cold Weather Protection:** If `temp` is significantly below setpoint (default: < 25.4°C) and air quality is acceptable, `fan_level` is capped at `FAN_COLD_MAX_PCT` (default: 35%).
*   **Heater Interaction:** If the heater is running, `fan_level` is forced to a minimum of `HEATER_MIN_FAN` (default: 20%).
*   **Limits:** Clamped between `FAN_MIN` (0%) and `FAN_MAX` (100%).
*   **Rate Limiting:** Changes are limited to `FAN_RATE_LIMIT_PER_MIN` (default: 80%/min).

### 1.2. Heater Control
The heater uses a hysteresis loop for activation and a proportional controller for intensity.

**Activation Logic (Hysteresis):**
*   **Turn ON** when `temp <= TEMP_SETPOINT - Deadband` (e.g., < 25.6°C).
*   **Turn OFF** when `temp >= TEMP_SETPOINT + Deadband` (e.g., > 26.4°C).
*   **Min Run/Stop Times:** Enforced minimum ON/OFF times (default: 120s) to prevent rapid cycling.

**Intensity Equation:**
When ON:
```python
temp_deficit = max(0, TEMP_SETPOINT - temp)
heater_level = min(100.0, HEATER_KP_TEMP * temp_deficit)
```
*   **Constraint:** If ON, minimum level is `HEATER_MIN_LEVEL` (10%).

### 1.3. Inlet Control
Inlet opening percentage is coupled with the fan speed but adjusted for air quality to ensure fresh air intake.

**Equation:**
```python
inlet_open = 20.0 + (0.6 * fan_level)

# Air Quality Adjustments
if co2 > CO2_SETPOINT:
    inlet_open += min(20.0, (co2_error) / 50.0)

if nh3 > NH3_THRESHOLD:
    inlet_open += min(15.0, (nh3_error) * 1.5)
```
*   **Limits:** Clamped between `INLET_MIN_PCT` (10%) and 100%. rate limited to `INLET_RATE_LIMIT_PER_MIN`.

### 1.4. Feed & Water Control
Refilling is managed by a simple **Hysteresis (Bang-Bang)** controller.

**Logic:**
*   **Refill ON** when level <= `LOW_THRESHOLD` (e.g., Feed < 1.5kg).
*   **Refill OFF** when level >= `HIGH_THRESHOLD` (e.g., Feed > 2.5kg).

### 1.5. Light Control
Lighting is adjusted to maintain bird activity levels using a Proportional controller.

**Equation:**
```python
activity_error = ACTIVITY_MIN - activity
light_level = 60.0 + (70.0 * activity_error)
```
*   **High Activity Damper:** If `activity > LIGHT_ACTIVITY_HIGH` (0.85), `light_level` is reduced by 20%.
*   **Day/Night Cycle:** 
    *   Between `LIGHTS_ON_H` (06:00) and `LIGHTS_OFF_H` (22:00): Min light is `LIGHT_MIN_DAY_PCT` (30%).
    *   Night: Min light is `LIGHT_MIN_NIGHT_PCT` (5%).

---

## 2. Environment Model (Physical Rules)

The environment (`environment/model.py`) simulates physics based on mass and energy balance equations.

### 2.1. Temperature Changes
Temperature evolution is driven by heat gains (heater, birds) and heat losses (conduction, ventilation).

**Differential Equation:**
$$ \frac{dT}{dt} = \frac{Q_{heater} + Q_{birds} - Q_{loss} - Q_{vent}}{C_{thermal}} $$

Where:
*   $Q_{heater} = P_{max} \times \frac{\text{heater\_level}}{100}$
*   $Q_{birds} = N_{birds} \times (10W + 6W \times \text{activity})$
*   $Q_{loss} = UA \times (T_{inside} - T_{outside})$ (Conduction through walls)
*   $Q_{vent} = \rho \cdot C_p \cdot \text{FlowRate} \times (T_{inside} - T_{outside})$ (Ventilation loss)

### 2.2. CO2 Concentration
CO2 depends on bird respiration (source) and ventilation (sink).

**Differential Equation:**
$$ \frac{d[CO2]}{dt} = \text{Generation} - \text{Ventilation} $$
*   **Generation:** $\propto N_{birds} \times (1 + 1.5 \times \text{activity})$
*   **Ventilation:** $\propto \text{FlowRate} \times ([CO2]_{outside} - [CO2]_{inside})$

### 2.3. Ammonia (NH3) Concentration
NH3 is generated by waste and removed by ventilation and natural decay.

**Differential Equation:**
$$ \frac{d[NH3]}{dt} = \text{Generation} - \text{Ventilation} - \text{Decay} $$
*   **Generation:** $\propto N_{birds} \times \text{TemperatureFactor} \times \text{ActivityFactor}$
*   **Decay:** Chemical decomposition rate.

### 2.4. Flow Rate
The ventilation flow rate depends on fan speed and inlet opening.

$$ \text{Flow} = \text{Flow}_{infiltration} + \text{Flow}_{max} \times \frac{\text{fan\_level}}{100} \times (0.2 + 0.8 \times \frac{\text{inlet\_pct}}{100}) $$

---

## 3. Analyzer Thresholds (Monitoring)

The analyzer (`analyzer/analyzer_service.py`) checks sensor values against global configuration limits to generate alerts.

| Parameter | Condition for "OK" | Default Config |
| :--- | :--- | :--- |
| **Temperature** | `temp_min <= val <= temp_max` | 20°C - 30°C |
| **CO2** | `val <= co2_max` | 3000 ppm |
| **Ammonia** | `val <= nh3_threshold` | 25 ppm |
| **Feed** | `val >= feed_threshold` | 1.5 kg |
| **Water** | `val >= water_threshold` | 0.8 L |
| **Activity** | `val >= activity_min` | 0.3 |
